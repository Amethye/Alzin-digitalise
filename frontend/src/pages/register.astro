---
import Layout from "@layouts/Layout.astro";
const next = Astro.url.searchParams.get("next") || "/";
---

<Layout title="Inscription">
  <main class="flex flex-1 flex-col items-center justify-center gap-4 px-4 py-6">
    <section class="w-full max-w-md">
      <div class="w-full max-w-md rounded-xl bg-white px-5 py-6 shadow-lg sm:px-8">
        
        <h1 class="mb-2 text-xl font-semibold text-mauve sm:text-2xl">
          Inscription
        </h1>

        <form id="registerForm" class="stack" novalidate>

          <label class="flex flex-col gap-1">
            Nom
            <input id="nom" type="text" required
              class="border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-mauve" />
          </label>

          <label class="flex flex-col gap-1">
            Prénom
            <input id="prenom" type="text" required
              class="border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-mauve" />
          </label>

          <label class="flex flex-col gap-1">
            Email
            <input id="email" type="email" placeholder="exemple@domaine.com" required
              class="border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-mauve" />
          </label>

          <label class="flex flex-col gap-1">
            Pseudo
            <input id="pseudo" type="text" required
              class="border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-mauve" />
          </label>

          <label class="flex flex-col gap-1">
            Ville
            <input id="ville" type="text" required
              class="border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-mauve" />
          </label>

          <label class="flex flex-col gap-1">
            Mot de passe
            <input id="password" type="password" placeholder="••••••••" required
              class="border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-mauve" />
          </label>

          <label class="flex flex-col gap-1">
            Confirmer le mot de passe
            <input id="password2" type="password" placeholder="••••••••" required
              class="border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-mauve" />
          </label>

          <button
            type="submit"
            class="btn btn-solid w-full">
            S'inscrire
          </button>

          <p id="err" class="text-red-600 text-sm"></p>
          <p id="success" class="text-green-600 text-sm"></p>

        </form>

        <style>
          .stack {
            display: flex;
            flex-direction: column;
            gap: .8rem;
            max-width: 380px;
          }
          input {
            padding: .55rem .7rem; 
            font-size: 1rem; 
          }
        </style>

      </div>
    </section>
  </main>
</Layout>

<script>
  type RegisterResponse = {
    success?: boolean;
    error?: string;
  };

  const form = document.getElementById("registerForm")!;
  const $err = document.getElementById("err")!;
  const $success = document.getElementById("success")!;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    $err.textContent = "";
    $success.textContent = "";

    const fields = ["nom", "prenom", "email", "pseudo", "ville", "password", "password2"];
    const data = Object.fromEntries(
      fields.map(id => [
        id,
        (document.getElementById(id)! as HTMLInputElement).value.trim()
      ])
    );

    if (Object.values(data).some(v => !v)) {
      $err.textContent = "Tous les champs sont obligatoires.";
      return;
    }

    if (data.password !== data.password2) {
      $err.textContent = "Les mots de passe ne correspondent pas.";
      return;
    }

    const res = await fetch("/api/utilisateurs/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({
        nom: data.nom,
        prenom: data.prenom,
        email: data.email.toLowerCase(),
        pseudo: data.pseudo,
        ville: data.ville,
        password: data.password,
      }),
    });

    let json: RegisterResponse = {};

    try { 
      json = await res.json(); 
    } catch {}

    if (!res.ok || !json.success) {
      $err.textContent = json.error || ("Erreur " + res.status);
      return;
    }

    $success.textContent = "Inscription réussie !";

    setTimeout(() => {
      location.href = new URLSearchParams(window.location.search).get("next") || "/";
    }, 900);
  });
</script>
